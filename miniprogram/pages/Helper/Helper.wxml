<view class="container">
  <scroll-view
    class="chat-container"
    scroll-y
    scroll-into-view="{{scrollToView}}"
    scroll-with-animation
    style="height: calc(100% - 60px);"
    bindscrolltolower="onScrollToLower"
  >
    <block wx:for="{{messages}}" wx:key="index">
      <view class="chat-bubble {{item.isSender ? 'sender' : 'receiver'}}" id="msg{{index}}">
        <block wx:if="{{item.type === 'text'}}">
          <text>{{item.message}}</text>
        </block>
        <block wx:elif="{{item.type === 'image'}}">
          <image 
            src="{{item.imgUrl}}" 
            mode="widthFix" 
            style="max-width: 200px; margin-top: 10px;" 
            binderror="onImageError" 
            bindtap="previewImage"
            data-src="{{item.imgUrl}}"
            data-index="{{index}}" 
            data-retry-count="{{item.retryCount || 0}}"
          />
        </block>
      </view>
    </block>
    <view wx:if="{{isWaiting}}" class="chat-bubble receiver">
      <text class="waiting-dots">.....</text>
    </view>
    <view wx:if="{{isWaitingImage}}" class="chat-bubble receiver">
      <image src="../../images/loading.gif" mode="widthFix" style="max-width: 50px; margin-top: 10px;" />
    </view>
    <view wx:if="{{isTyping}}" class="chat-bubble receiver">
      <text>{{typingMessage}}</text>
    </view>
    <view id="bottom" style="height: 1px;"></view>
  </scroll-view>
  
  <view class="input-container">
    <input
      class="input"
      value="{{inputValue}}"
      bindinput="onInput"
      placeholder="输入消息内容"
    />
    <button class="send-btn" bindtap="onSend">
      <image src="../../images/send.png" style="width: 20px; height: 20px;" />
    </button>
    <button class="send-btn" bindtap="chooseImage">
      <image src="../../images/files.png" style="width: 20px; height: 20px;" />
    </button>
  </view>
</view>
